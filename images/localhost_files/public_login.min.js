(function(win,doc){"use strict";var LOGIN_URL="http://id.ifeng.com/allsite/login";var LOGIN_SID_INTERVAL=null;var LOGIN_TK_INTERVAL=null;var LOGIN_SUCCESS_CALLBACK=[];var LOGIN_CLOSE_CALLBACK=[];var LOGIN_OUT_CALLBACK=[];var login_init=function(){if(login_cookie.get("sid")){if(LOGIN_SUCCESS_CALLBACK.length>0){for(var e=0,n=LOGIN_SUCCESS_CALLBACK.length;e<n;e++){LOGIN_SUCCESS_CALLBACK[e]({sid:login_cookie.get("sid"),uname:_processSidtoUname()})}}}else{_loginShow()}};var _login_listening=function(){clearInterval(LOGIN_TK_INTERVAL);clearInterval(LOGIN_SID_INTERVAL);LOGIN_TK_INTERVAL=setInterval(_processTK,100);LOGIN_SID_INTERVAL=setInterval(_processSID,100)};var _processSID=function(){var e={};if(login_cookie.get("sid")){clearInterval(LOGIN_SID_INTERVAL);clearInterval(LOGIN_TK_INTERVAL);e.sid=login_cookie.get("sid");e.uname=_processSidtoUname();doc.getElementById("login_index").parentNode.removeChild(doc.getElementById("login_index"));doc.getElementById("masker").parentNode.removeChild(doc.getElementById("masker"));if(LOGIN_SUCCESS_CALLBACK.length>0){for(var n=0,i=LOGIN_SUCCESS_CALLBACK.length;n<i;n++){LOGIN_SUCCESS_CALLBACK[n](e)}}}};var _processTK=function(){var OTK="";if(""!==login_cookie.get("IF_OTK")){clearInterval(LOGIN_TK_INTERVAL);OTK=eval("("+decodeURIComponent(login_cookie.get("IF_OTK"))+")");if(1===OTK.code){login_cookie.del("IF_OTK",".ifeng.com");doc.getElementById("login_iframe_out").innerHTML='<iframe id="login_iframe" width="520" height="320" scrolling="no" frameborder="no" border="0" style="border:0px; margin:0px;padding:0px;" src="'+OTK.data.url+'"></iframe>'}else{login_cookie.del("IF_OTK",".ifeng.com");doc.getElementById("login_iframe_out").innerHTML='<iframe id="login_iframe" width="520" height="410" scrolling="no" frameborder="no" border="0" style="border:0px; margin:0px;padding:0px;" src="'+LOGIN_URL+'"></iframe>';alert(OTK.message)}_login_listening()}};var _loginShow=function(){var e=doc.body,n=doc.getElementById("login_index"),i=null,o=null;var t=_getDom(e.lastChild);if("undefined"!==typeof t){if("undefined"===typeof n||null===n){i=doc.createElement("div");i.id="masker";i.style.cssText="background:#000; position:fixed; left:0; top:0; bottom:0px; width:100%; height:100%; opacity:.80; filter:alpha(opacity=80); z-index:9999; overflow:hidden; zoom: 1; display: block;";t.parentNode.insertBefore(login_html(),t);doc.getElementById("login_index").parentNode.insertBefore(i,doc.getElementById("login_index"));doc.getElementById("login_iframe_contain").style.cssText="position:fixed; _position:absolute; top:50%; left:50%; margin-left:-260px; margin-top: -207px; z-index:99999;"}else{if(doc.getElementById("login_iframe_out")){doc.getElementById("login_iframe_out").innerHTML='<iframe id="login_iframe" width="520" height="410" scrolling="no" frameborder="no" border="0" style="border:0px; margin:0px;padding:0px;" src="'+LOGIN_URL+'"></iframe>'}i=doc.getElementById("masker");i["style"]["display"]="block";n["style"]["display"]="block"}o=doc.getElementById("login_iframe_close_btn");_bindEvent.add(o,"click",_loginHide);_login_listening()}};var _loginHide=function(){clearInterval(LOGIN_TK_INTERVAL);clearInterval(LOGIN_SID_INTERVAL);doc.getElementById("login_index").parentNode.removeChild(doc.getElementById("login_index"));doc.getElementById("masker").parentNode.removeChild(doc.getElementById("masker"));if(LOGIN_CLOSE_CALLBACK.length>0){for(var e=0,n=LOGIN_CLOSE_CALLBACK.length;e<n;e++){LOGIN_CLOSE_CALLBACK[e]()}}};var login_out=function(){var e=function(e){var n=0,i="",o=[],t=null,r=null,l=null;if(1===e.code){for(;n<e.data.turl.length;n++){i='<iframe style="display: none;" id="logout_'+n+'_iframe" src="'+e.data.turl[n]+'"></iframe>';o.push(i)}t=document.createElement("div");t.id="iframesDIV";t.innerHTML=o.join("");r=_getDom(document.body.lastChild);r.parentNode.insertBefore(t,r);l=setInterval(function(){if(""===login_cookie.get("sid")){clearInterval(l);if(LOGIN_OUT_CALLBACK.length>0){for(var e=0,n=LOGIN_OUT_CALLBACK.length;e<n;e++){LOGIN_OUT_CALLBACK[e]()}}}},100)}};var n={url:"http://id.ifeng.com/index.php/api/logout",success:e};ajax.jsonp(n)};var _getDom=function(e){if(e.nodeType===1){return e}if(e.previousSibling){return _getDom(e.previousSibling)}return null};var _bindEvent={add:function(e,n,i){if(e.attachEvent){e["e"+n+i]=i;e[n+i]=function(){e["e"+n+i](window.event)};e.attachEvent("on"+n,e[n+i])}else{e.addEventListener(n,i,false)}},remove:function(e,n,i){if(e.detachEvent){e.detachEvent("on"+n,e[n+i]);e[n+i]=null}else{e.removeEventListener(n,i,false)}}};var login_html=function(){var e=doc.createElement("div"),n="http://y0.ifengimg.com/p/login/20130924/close_01.png";e.id="login_index";e.style.cssText="width:1000px; margin:0 auto; display: block;";e.innerHTML='<div id="login_iframe_contain">'+'<i id="login_iframe_close_btn" style="cursor:pointer; position:absolute; right:-10px; top:-10px;">'+'<a href="javascript:;" style="cursor:pointer;width:26px;height:26px;overflow:hidden;background:url('+n+") no-repeat;display:block;text-indent:-9999px;_background:none;_filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled=true, sizingMethod=scale, src='"+n+"');\">关闭</a>"+"</i>"+'<div id="login_iframe_out">'+'<iframe id="login_iframe" width="520" height="410" scrolling="no" frameborder="no" border="0" style="border:0px; margin:0px;padding:0px;" src="'+LOGIN_URL+'"></iframe>'+"</div>"+"</div>";return e};var login_cookie={get:function(e){var n=login_cookie,i=document.cookie,o=n._removeBlanks(i),t=o.split(";");for(var r=0;r<t.length;r++){var l=t[r].split("=");if(l.length>1&&l[0]===e){return l[1]}}return""},del:function(e,n){document.cookie=e+"=; path=/; domain="+n+"; expires=Thu, 01-Jan-70 00:00:01 GMT"},_removeBlanks:function(e){var n="";for(var i=0;i<e.length;i++){var o=e.charAt(i);if(o!==" "){n+=o}}return n}};var ajax={jsonp:function(e){var n=e.url;var i=e.success;var o=[];var t=e.scope||window;var r;if(typeof e.data==="object"){for(var l in e.data){o.push(l+"="+encodeURIComponent(e.data[l]))}}if(typeof e.callback==="string"&&e.callback!==""){r=e.callback}else{r="f"+(new Date).valueOf().toString(16)}o.push("callback="+r);o.push("_="+(new Date).valueOf());if(n.indexOf("?")<0){n=n+"?"+o.join("&")}else{n=n+"&"+o.join("&")}var a=document.createElement("script");a.src=n;window[r]=function(){i.apply(t,[].slice.apply(arguments).concat("success",e))};var d=document.getElementsByTagName("script")[0];d.parentNode.insertBefore(a,d)}};var _processSidtoUname=function(){return login_cookie.get("sid")?decodeURIComponent(login_cookie.get("sid").substring(32)):decodeURIComponent(login_cookie.get("IF_USER"))};var isLogin=function(){return login_cookie.get("sid")?true:false};var regLoginCallback=function(e,n){if("undefined"===typeof e||"undefined"===typeof n){return false}switch(e){case 1:if("function"===typeof n){LOGIN_SUCCESS_CALLBACK.push(n);break}case 2:if("function"===typeof n){LOGIN_CLOSE_CALLBACK.push(n);break}case 3:if("function"===typeof n){LOGIN_OUT_CALLBACK.push(n);break}}};win.IS_LOGIN=isLogin;win.GLOBAL_LOGIN=login_init;win.GLOBAL_LOGIN_OUT=login_out;win.REG_LOGIN_CALLBACK=regLoginCallback})(window,document);